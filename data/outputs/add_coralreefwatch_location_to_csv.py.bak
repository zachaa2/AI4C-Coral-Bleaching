import pandas as pd
import os
import requests

reef_watch_names_dic = {"Biscayne Bay": "southeast_florida", "Curacao":"abc_islands", "Pacific National Historical Park, Guam":"guam"}

def get_sst_90th_hs(row):
    url = 'https://coralreefwatch.noaa.gov/product/vs/data/{}.txt'.format(row["CoralReefWatch location"])
    date = row["date"]

    # Step 1: Download the text file
    response = requests.get(url)
    if response.status_code != 200:
        print("Error: Unable to fetch the data file.")
        return None
    
    # Step 2: Read the file and search for the date
    lines = response.text.splitlines()
    
    # Step 3: Parse the file to find the data for the given date
    for line in lines:
        # Split the line into fields based on whitespace (assuming tab-delimited or space-separated)
        fields = line.split()
        
        if len(fields) > 0:
			print(fields)
			file_date = fields[0]+"-"+fields[1]+"-"+fields[2]
            
			# Step 4: Compare the date to the input date
 			if file_date == date:
 				# Extract SST@90th_HS (Assumed to be in a known column, here we assume it's column 5)
 				# Adjust the index according to the actual format of the file
 				try:
					sst_90th_hs = fields[5]  # Update index based on the actual column of SST@90th_HS
					return sst_90th_hs
				except IndexError:
					print(f"Error: SST@90th_HS not found in the expected column for date {date}.")
					return None

	# If the date is not found in the file
	print(f"Error: No data found for the date {date}.")
	return None

for dir in os.listdir("images"):
	csv_file_path = "images/{}/metadata.csv".format(dir)
	df = pd.read_csv(csv_file_path)
	df["CoralReefWatch location"] = reef_watch_names_dic[df.loc[0, "location"]]
	df["SST@90th_HS"] = df.apply(get_sst_90th_hs, axis=1)
	df.to_csv(csv_file_path, index=False)